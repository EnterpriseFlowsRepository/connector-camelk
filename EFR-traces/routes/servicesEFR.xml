<?xml version="1.0" encoding="UTF-8"?>
<!-- camel-k: language=xml -->
<!-- camel-k: dependency=camel-http -->

<routes xmlns="http://camel.apache.org/schema/spring">

  <!-- Send ONE trace to EFR -->
  <route id="efr-trace-mono">
    <from uri="direct:efr-trace-mono" />

    <removeHeaders pattern="*"/>
    <setHeader name="Exchange.CONTENT_TYPE">
      <constant>application/json; charset=utf-8</constant>
    </setHeader>
    <setHeader name="Authorization">
      <simple>Bearer ${exchangeProperty.OIDC-access_token}</simple>
    </setHeader>
    <setHeader name="CamelHttpMethod">
      <constant>POST</constant>
    </setHeader>

    <toD uri="{{efr.traces.post}}"/>
  </route>

  <!-- Send MULTIPLE trace to EFR -->
  <route id="efr-trace-multi">
    <from uri="direct:efr-trace-multi" />

    <removeHeaders pattern="*"/>
    <setHeader name="Exchange.CONTENT_TYPE">
      <constant>application/json; charset=utf-8</constant>
    </setHeader>
    <setHeader name="Authorization">
      <simple>Bearer ${exchangeProperty.OIDC-access_token}</simple>
    </setHeader>
    <setHeader name="CamelHttpMethod">
      <constant>PUT</constant>
    </setHeader>

    <doTry>
      <toD uri="{{efr.traces.put}}"/>
      <log message="Sent ${exchangeProperty[traces-count]} traces to EFR: ${header.CamelHttpResponseCode}." loggingLevel="INFO" />

      <doCatch>
        <exception>org.apache.camel.http.base.HttpOperationFailedException</exception>
        <log message="HTTP Operation Exception. Message: ${exception.message}" loggingLevel="ERROR" />
        <process ref="retry__incrementOrStop"/>
        <delay><constant>{{efr-sendtraces.retry.delay}}</constant></delay>

        <to uri="direct:efr-sendtraces-send-aggregated" />
        <stop/>
      </doCatch>
    </doTry>
  </route>
</routes>
